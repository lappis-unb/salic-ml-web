{% extends 'base.html' %} {% block content %}

<div class="ui fixed inverted menu" id="ProjectID">
    <a class="ui icon inverted button" id="btBack" href="{% url 'index' %}">
        <i class="left arrow icon"></i>
    </a>
    <div class="ui tiny inverted statistic">
        <div class="label">PRONAC</div>
        <div class="value">{{project.pronac}}</div>
    </div>
    <h1>{{project.name}}</h1>
    {% if user %}
    <div class="header Element-space-between">
        - Bem vindo(a) {{user.name}}!
    </div>
    {% endif %}
</div>

{% if not user %}
<div class="ui ten column centered grid" style="margin-top:50px;">
    <div class="ui raised segment" id="LoginArea">
        <div class="ui form">
            <div class="header">
                Preencha seus dados para avaliar este projeto (ou para continuar uma avaliação interrompida):
            </div>
            <form action="/user_info" method="post">
                {% csrf_token %}
                <div class="three fields">
                    <div class="six wide field">
                        <input required placeholder="Nome Completo" type="text" name="user_first_name">
                    </div>
                    <div class="seven wide field">
                        <div class="ui right labeled input">
                            <input required placeholder="Email" type="text" name="user_email">
                            <div class="ui label">
                                @cultura.gov.br
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="project_pronac" value="{{ project.pronac }}">
                    <div class="two wide field">
                        <input class="ui submit button primary" type="submit" value="Enviar">
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %} {% for indicator in project_indicators %}

<!-- Este aqui de baixo é para ser o original -->
<!-- <div class="ui icon message Element-space-between">
    <div class="clearfix">
        <div id="indicatorContainer"></div>
    </div>
    <h3 class="Complexity-text">Diagnóstico de </h3>
</div> -->
<div class="ui clearing basic segment" id="Summary">
    <div class="clearfix" style="margin-right: 30px;">
        <div id="indicatorContainer"></div>
    </div>
    <h1 class="ui header">
        Diagnóstico de complexidade da prestação de contas
    </h1>
</div>
<!-- <div class="ui clearing basic segment" id="Summary">
    <div class="c100 p70 big orange">
        <span>70%</span>
        <div class="slice">
            <div class="bar"></div>
            <div class="fill"></div>
        </div>
    </div>
    <h1 class="ui header">
        Diagnóstico de complexidade da prestação de contas
    </h1>
</div> -->

<form action="/metrics_feedback" method="post">
    {% csrf_token %}
    <div class="ui basic segment" id="DiagnosticArea">

        <div class="ui styled fluid accordion" id="DiagnosticMetrics">

            <!-- METRIC -->
            <!-- Total do número de itens -->
            <div class="title active {{indicator.metrics.0.outlier_check}}">
                <div class="ui ribbon label">
                    <i class="icon"></i>
                </div>
                <span>Itens orçamentários: {{indicator.metrics.0.value}}</span>
                <i class="dropdown icon"></i>
                <div class="helper">
                    <i class="question circle outline icon"></i>
                    <div class="ui floating message">
                        <p>Compara a quantidade de itens deste projeto com a
                            <strong>quantidade mais comum</strong> de itens em projetos do mesmo segmento</p>
                    </div>
                </div>
            </div>

            <div class="content active Metric-bad">
                <!-- Barra de distribuição de itens nesse projeto em relação à média do segmento -->
                <div class="ui pointing below label">
                    Este projeto
                </div>
                <div class="ui progress" data-percent="12" data-total="1000" id="MedianDisplay-TotalItems">
                    <div class="bar">
                        <div class="progress">50 - 170</div>
                    </div>
                    <div class="label">Média de itens orçamentários para Jogos Eletrônicos</div>
                </div>

                <div class="ui fedback form">
                    <div class="ui divider"></div>
                    <div class="header">Quanto essa informação é útil para você?</div>
                    <div class="fields">
                        <div class="four wide field rating-star">
                            <div class="ui massive star rating" name="itens_orcamentarios_rating"></div>
                        </div>
                        <div class="inline field">
                            <input placeholder="Por quê?" type="text" size="50" name="itens_orcamentarios_text">
                        </div>
                    </div>
                </div>
            </div>

            <!-- METRIC -->
            <!-- 1 Porcentagem de itens do projeto em relação a distribuição dos itens mais comuns para aquele segmento ou area -->
            <div class="title active Metric-average">
                <div class="ui ribbon label">
                    <i class="icon"></i>
                </div>
                <span>Itens orçamentários fora do comum: {{indicator.metrics.1.value}}%</span>
                <i class="dropdown icon"></i>
                <div class="helper">
                    <i class="question circle outline icon"></i>
                    <div class="ui floating message">
                        <p>Indica os itens orçamentários deste projeto que
                            <strong>não estão entre os mais comuns</strong> do segmento.</p>
                        <p>Também lista os itens que aparecem frequentemente em projetos do segmento, mas que
                            <strong>não aparecem neste projeto</strong>.</p>
                    </div>
                </div>
            </div>
            <div class="content active">
                <div class="ui grid">
                    <div class="eight wide column">
                        <div class="list header">Itens inesperados</div>
                        <div class="ui bulleted list">
                            {% for itens in indicator.metrics.1.expected_itens %}
                            <div class="item">
                                <a href="{{itens.link}}">{{itens.name}}</a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="eight wide column">
                        <div class="list header">Itens ausentes</div>
                        <div class="ui bulleted list">
                            {% for itens in indicator.metrics.1.missing_itens %}
                            <div class="item">
                                <a href="{{itens.link}}">{{itens.name}}</a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="ui fedback form">
                        <div class="ui divider"></div>
                        <div class="header">Quanto essa informação é útil para você?</div>
                        <div class="fields">
                            <div class="five wide field rating-star">
                                <div class="ui massive star rating" name="itens_orcamentarios_fora_do_comum_rating"></div>
                            </div>
                            <div class="inline field">
                                <input placeholder="Por quê?" type="text" size="50" name="itens_orcamentarios_fora_do_comum_text">
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- METRIC -->
            <!-- Número de comprovantes do projeto-->
            <div class="title active Metric-good">
                <div class="ui ribbon label">
                    <i class="icon"></i>
                </div>
                Comprovantes de pagamento: {{indicator.metrics.2.value}}
                <i class="dropdown icon"></i>
                <div class="helper">
                    <i class="question circle outline icon"></i>
                    <div class="ui floating message">
                        <p>Compara a quantidade de comprovantes deste projeto com a
                            <strong>quantidade mais comum</strong> de comprovantes em projetos do mesmo segmento</p>
                    </div>
                </div>
            </div>
            <div class="content active">
                <h3>(Barra de distribuição de da quant de comprovantes nesse projeto em relação à média do segmento)</h3>
                <div class="ui fedback form">
                    <div class="ui divider"></div>
                    <div class="header">Quanto essa informação é útil para você?</div>
                    <div class="fields">
                        <div class="four wide field rating-star">
                            <div class="ui massive star rating" name="comprovantes_pagamento_rating"></div>
                        </div>
                        <div class="inline field">
                            <input placeholder="Por quê?" type="text" size="50" name="comprovantes_pagamento_text">
                        </div>
                    </div>
                </div>
            </div>


            <!-- METRIC -->
            <!-- 5 Porcentagem de itens acima da mediana histórica, média do desvio da mediana, ou o próprio vetor de diferença em relação a mediana -->
            <div class="title active Metric-bad">
                <div class="ui ribbon label">
                    <i class="icon"></i>
                </div>
                <span>Preços acima da média: {{indicator.metrics.3.value}}%</span>
                <i class="dropdown icon"></i>
                <div class="helper">
                    <i class="question circle outline icon"></i>
                    <div class="ui floating message">
                        <p>Verifica a porcentagem de itens com valor acima da mediana histórica neste projeto e compara com
                            a
                            <strong>porcentagem mais frequente</strong> de itens acima da mediana em projetos do mesmo segmento</p>
                    </div>
                </div>
            </div>
            <div class="content active">
                <h3>(Barra de distribuição em relação à média)</h3>
                <div class="ui fedback form">
                    <div class="ui divider"></div>
                    <div class="header">Quanto essa informação é útil para você?</div>
                    <div class="fields">
                        <div class="four wide field rating-star">
                            <div class="ui massive star rating" name="precos_acima_media_rating"></div>
                        </div>
                        <div class="inline field">
                            <input placeholder="Por quê?" type="text" size="50" name="precos_acima_media_text">
                        </div>
                    </div>
                </div>
            </div>


            <!-- METRIC -->
            <!-- Total do valor comprovado do projeto -->
            <div class="title active Metric-bad">
                <div class="ui ribbon label">
                    <i class="icon"></i>
                </div>
                <span>Valor comprovado: R${{indicator.metrics.4.value}}</span>
                <i class="dropdown icon"></i>
                <div class="helper">
                    <i class="question circle outline icon"></i>
                    <div class="ui floating message">
                        <p>Compara o valor comprovado neste projeto com o
                            <strong>valor mais frequentemente</strong> comprovado em projetos do mesmo segmento</p>
                    </div>
                </div>
            </div>
            <div class="content active">
                <h3>(Barra de distribuição do valor do projeto em relação à média do segmento)</h3>
                <div class="ui fedback form">
                    <div class="ui divider"></div>
                    <div class="header">Quanto essa informação é útil para você?</div>
                    <div class="fields">
                        <div class="four wide field rating-star">
                            <div class="ui massive star rating" name="valor_comprovado_rating"></div>
                        </div>
                        <div class="inline field">
                            <input placeholder="Por quê?" type="text" size="50" name="valor_comprovado_text">
                        </div>
                    </div>
                </div>
            </div>


            <!-- METRIC -->
            <!-- Total do valor captado do projeto-->
            <div class="title active Metric-average">
                <div class="ui ribbon label">
                    <i class="icon"></i>
                </div>
                <span>Valor captado: R${{indicator.metrics.5.value}}</span>
                <i class="dropdown icon"></i>
                <div class="helper">
                    <i class="question circle outline icon"></i>
                    <div class="ui floating message">
                        <p>Compara o valor captado neste projeto com o
                            <strong>valor mais frequentemente</strong> captado em projetos do mesmo segmento</p>
                    </div>
                </div>
            </div>
            <div class="content active">
                <h3>(Barra de distribuição do valor do projeto em relação à média do segmento)</h3>
                <div class="ui fedback form">
                    <div class="ui divider"></div>
                    <div class="header">Quanto essa informação é útil para você?</div>
                    <div class="fields">
                        <div class="four wide field rating-star">
                            <div class="ui massive star rating" name="valor_captado_rating"></div>
                        </div>
                        <div class="inline field">
                            <input placeholder="Por quê?" type="text" size="50" name="valor_captado_text">
                        </div>
                    </div>
                </div>
            </div>


            <!-- METRIC -->
            <!-- 3 Como a planilha, incluindo itens e preços, mudam ao longo do tempo em termos de rubrica ou outra categoria -->
            <div class="title active Metric-good">
                <div class="ui ribbon label">
                    <i class="icon"></i>
                </div>
                <span>Mudanças na planilha orçamentária: R${{indicator.metrics.6.value}}</span>
                <i class="dropdown icon"></i>
                <div class="helper">
                    <i class="question circle outline icon"></i>
                    <div class="ui floating message">
                        <p>Compara o quantidade de mudanças de valor em itens orçamentários neste projeto com a
                            <strong>quantidade de mudanças mais frequente</strong> em projetos do mesmo segmento.</p>
                        <p>Também indica quantas versões de planilha orçamentária foram geradas até a prestação de contas.</p>
                    </div>
                </div>
            </div>
            <div class="content active">
                <h3>(Barra de distribuição de quant. de mudanças nesse proj em relação à média do segmento)</h3>
                <h3>Versões de planilha orçamentária: {{indicator.metrics.6.document_version}}</h3>
                <div class="ui fedback form">
                    <div class="ui divider"></div>
                    <div class="header">Quanto essa informação é útil para você?</div>
                    <div class="fields">
                        <div class="four wide field rating-star">
                            <div class="ui massive star rating" name="mudancas_planilha_orcamentaria_rating"></div>
                        </div>
                        <div class="inline field">
                            <input placeholder="Por quê?" type="text" size="50" name="mudancas_planilha_orcamentaria_text">
                        </div>
                    </div>
                </div>
            </div>


            <!-- METRIC -->
            <!-- 2 Número de projetos já enviados por aquele proponente ou outros "escritores" da proposta -->
            <div class="title active Metric-good">
                <div class="ui ribbon label">
                    <i class="icon"></i>
                </div>
                <span>Projetos do mesmo proponente: {{indicator.metrics.7.value}}</span>
                <i class="dropdown icon"></i>
                <div class="helper">
                    <i class="question circle outline icon"></i>
                    <div class="ui floating message">
                        <p>Indica os projetos que o proponente já executou no passado.</p>
                    </div>
                </div>
            </div>
            <div class="content active">
                <div class="ui bulleted list">
                    {% for project in indicator.metrics.7.proponent_projects %}
                    <div class="item">
                        <a href="{{project.link}}">{{project.name}}</a>
                    </div>
                    {% endfor %}
                </div>
                <div class="ui fedback form">
                    <div class="ui divider"></div>
                    <div class="header">Quanto essa informação é útil para você?</div>
                    <div class="fields">
                        <div class="four wide field rating-star">
                            <div class="ui massive star rating" name="projetos_mesmo_proponente_rating"></div>
                        </div>
                        <div class="inline field">
                            <input placeholder="Por quê?" type="text" size="50" name="projetos_mesmo_proponente_text">
                        </div>
                    </div>
                </div>
            </div>


            <!-- METRIC -->
            <!-- 4 Porcentagem ou distribuição dos fornecedores do projeto em relação a fornecedores já conhecidos -->
            <div class="title active Metric-good">
                <div class="ui ribbon label">
                    <i class="icon"></i>
                </div>
                <span>Novos fornecedores: {{indicator.metrics.8.value}}%</span>
                <i class="dropdown icon"></i>
                <div class="helper">
                    <i class="question circle outline icon"></i>
                    <div class="ui floating message">
                        <p>Indica a proporção de fornecedores que
                            <strong>nunca participaram de projetos</strong> de incentivo antes em relação ao total de fornecedores
                            envolvidos com o projeto.</p>
                        <p>Também lista os itens orçamentários dos novos fornecedores.</p>
                    </div>
                </div>
            </div>
            <div class="content active">
                <div class="accordion">
                    {% for provider in indicator.metrics.8.providers %}
                    <div class="title">
                        <i class="dropdown icon"></i>
                        {{provider.name}}
                    </div>
                    <div class="content">
                        <div class="ui bulleted list">
                            {% for itens in provider.itens_list %}
                            <div class="item">
                                <a href="{{itens.link}}">{{itens.name}}</a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                    <div class="ui fedback form">
                        <div class="ui divider"></div>
                        <div class="header">Quanto essa informação é útil para você?</div>
                        <div class="fields">
                            <div class="four wide field rating-star">
                                <div class="ui massive star rating" name="novos_fornecedores_rating"></div>
                            </div>
                            <div class="inline field">
                                <input placeholder="Por quê?" type="text" size="50" name="novos_fornecedores_text">
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- METRIC -->
            <!-- Total do valor aprovado do projeto -->
            <div class="title active Metric-good">
                <div class="ui ribbon label">
                    <i class="icon"></i>
                </div>
                <span>Valor aprovado: R${{indicator.metrics.9.value}}</span>
                <i class="dropdown icon"></i>
                <div class="helper">
                    <i class="question circle outline icon"></i>
                    <div class="ui floating message">
                        <p>Compara o valor aprovado para este projeto com o
                            <strong>valor mais frequentemente</strong> aprovado em projetos do mesmo segmento</p>
                    </div>
                </div>
            </div>
            <div class="content active">
                <h3>(Barra de distribuição em relação à média)</h3>
                <div class="ui fedback form">
                    <div class="ui divider"></div>
                    <div class="header">Quanto essa informação é útil para você?</div>
                    <div class="fields">
                        <div class="four wide field rating-star">
                            <div class="ui massive star rating" name="valor_aprovado_rating"></div>
                        </div>
                        <div class="inline field">
                            <input placeholder="Por quê?" type="text" size="50" name="valor_aprovado_text">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ui modal" id="erro-star">
            <div class="header">Pendência de avaliações</div>
            <div class="content">
                <p>Por favor, avalie todas as métricas através das estrelinhas.</p>
            </div>
            <div class="actions">
                <div class="ui primary cancel button">Ok, avaliarei!</div>
            </div>
        </div>

        <div class="ui modal" id="modal-sucess">
            <div class="header">Sucesso ao enviar o feedback</div>
            <div class="content">
                <p>Mensagem qualquer.</p>
            </div>
            <div class="actions">
                <div class="ui cancel button">Permanecer na página atual</div>
                <a class="ui primary button" href="{% url 'index' %}">
                    Ir para a lista dos projetos
                </a>
            </div>
        </div>

        <input type="hidden" name="all_ratings" value="" id="all_ratings">
        <input type="hidden" name="project_pronac" value="{{ project.pronac }}">
        <input type="hidden" name="user_email" value="{{ user.email }}">
        <div class="ui basic segment" id="FinalForm">
            <div class="ui equal width form">
                <div class="header">
                    Na sua opinião, como você avalia
                    <em>&ldquo;{{ project.name }}&rdquo;</em>:
                </div>
                <div class="inline fields">
                    {% for grade in project_feedback_list %}
                    <div class="field">
                        <div class="ui radio checkbox">
                            <input type="radio" required name="project_feedback_grade" value={{forloop.counter}}>
                            <label>{{ grade }}</label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <a class="scroll ui huge primary button" onmouseover="getRating()" onclick="showModal()" href="#first-star">
                Terminar Diagnóstico
            </a>
        </div>
        {% endfor %}
</form>


<script>
    function rmRedBorder() {
        var element = document.getElementsByClassName("rating-star");
        var classNameAdd = "borda-vermelha";
        for(var i = 0, size = element.length; i < size; ++i){
            var arr = element[i].className.split(" ");
            if (arr.indexOf(classNameAdd) == -1) {
                element[i].style = "border: none";
            }
        }
    }
    function addRedBorder() {
        var element = document.getElementsByClassName("rating-star");
        var classNameAdd = "borda-vermelha";
        for(var i = 0, size = element.length; i < size; ++i){
            var arr = element[i].className.split(" ");
            if (arr.indexOf(classNameAdd) == -1) {
                element[i].style = "border: solid 2px red";
            }
        }
    }

    // Make method to change complexity color
    var radialObj = $('#indicatorContainer').radialIndicator({
        radius: 70,
        barColor: {
            0: '#1B5E20',
            30: '#F2B01C',
            80: '#DB2828',
            100: '#DB2828'
        },
        barWidth: 10,
        initValue: 0,
        roundCorner: true,
        percentage: true
    }).data('radialIndicator');

    function getRating() {
        var value = $('.ui.rating').rating('get rating')
        var hidden_ratings = document.getElementById("all_ratings")
        
        var element = document.getElementsByClassName("rating-star");
        var classNameAdd = "borda-vermelha";
        
        var entrou = false;
        for(var i = 0, size = value.length; i < size; ++i){
            if(!value[i]){
                entrou = true;
                var arr = element[i].className.split(" ");
                if (arr.indexOf(classNameAdd) == -1) {
                    element[i].style = "border: solid 2px red";
                }
            }
            if(entrou) $('#erro-star').modal('show')              
        }
        hidden_ratings.value = value.join("")
    }

    $('.ui.rating').rating({
        initialRating: 0,
        maxRating: 5
    })
    function showModal() {
        rmRedBorder()
        $('#modal-sucess').modal('show')
    }
    $('.ui.accordion').accordion({ exclusive: false });

    radialObj.value("{{project_indicators.0.value}}")
</script> {% endblock %}